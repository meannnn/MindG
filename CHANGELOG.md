# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [5.27.0] - 2026-02-27

### Added
- **Free-form Prompt UX**: Unified generation flow—both free-form and specific diagram modes now generate on the landing page, then navigate to canvas when complete. No more immediate navigation with canvas loading.
- **Rainbow Glowing Animation**: When free-form mode ("选择具体图示") is generating, prompt box shows rainbow glowing border animation for visual feedback.
- **ElButton Loading State**: Replaced send button with Element Plus `ElButton` with loading spinner during generation for both modes.
- **useRadialLayout Composable**: New `useRadialLayout.ts` for shared radial/circular layout calculation (polar positions, no-overlap formula) used by bubble map, circle map, and similar diagrams.
- **Parallel LLM Generation**: Landing page uses first-success-wins parallel calls across multiple LLMs (qwen, deepseek, kimi, doubao) for faster free-form generation.
- **Abort on Unmount**: DiagramTemplateInput aborts in-flight generation on unmount to avoid leaks.

### Changed
- **DiagramTemplateInput**: Major refactor—unified `generateFromLanding()` for both modes, `authFetch` API call, `loadFromSpec` then `router.push('/canvas')`. Free-form passes `diagram_type: null`; specific diagram passes fixed type for backend enforcement. Renamed "选择图示" → "选择具体图示".
- **CanvasPage**: Removed `canvas:generate_with_prompt` listener, `autoGenerateDiagram`, and `customPrompt`—all generation now happens on landing.
- **CanvasTopBar**: Simplified (232 lines removed); generation logic moved to DiagramTemplateInput.
- **DiagramHistory**: Simplified (207 lines removed).
- **Backend Workflow**: Removed early return for free-form mode; flow now continues to full spec generation so API returns `spec` instead of `use_default_template`. Refactored agent kwargs to explicit parameters for bridge/tree/brace maps.
- **prompt_to_diagram_agent**: Consolidated and simplified (578 lines removed).
- **Bubble/Double Bubble Map Stores**: Enhanced spec loading and layout; integrated useRadialLayout.
- **Diagram Store**: Added `loadFromSpec` and related state for pre-loaded diagrams from landing.
- **UI Store**: Added `hasValidSlots()`, template slot validation.
- **LoginModal, ChangePhoneModal**: UI improvements.
- **Context Menu**: Enhanced with additional actions.
- **WorkshopModal, DiagramCanvas, RadialEdge**: Minor updates.
- **Logging Config**: Improved log levels/formatting.

### Removed
- **Canvas Generation Flow**: Removed generation-from-canvas flow; all diagram generation now originates from landing page.

## [5.26.0] - 2026-02-26

### Added
- **Diagram Export**: New `useDiagramExport.ts` composable for exporting diagrams as PNG, SVG, PDF (via html-to-image + jspdf), and JSON. Integrated into CanvasTopBar.
- **DiagramPreviewSvg**: New `DiagramPreviewSvg.vue` component with SVG previews for each diagram type in gallery and diagram type grid.
- **Color Palette Config**: New `colorPalette.ts` with WCAG AA contrast-compliant style presets (Simple, Creative, Business, Vibrant) from ColorHunt.
- **Style Presets Apply**: CanvasToolbar style presets now apply to all nodes via `applyStylePreset()`.

### Changed
- **CanvasToolbar**: Enhanced text formatting (B/I/U/S), font family/size dropdowns, text color palette, background/border color pickers. Style presets now apply to diagram nodes. EventBus integration for delete/add node.
- **Diagram Store**: Added `applyStylePreset()` for applying style presets to all nodes.
- **DiagramTypeGrid & DiscoveryGallery**: Use DiagramPreviewSvg for diagram type previews.
- **ImagePreviewModal**: Enhanced image preview modal.
- **Scripts Reorganization**: Moved DB scripts from `scripts/` to `scripts/db/` (check_admin_status, backfill_user_usage_stats, check_diagram_counts, clear_library_tables). Moved setup scripts to `scripts/setup/` (find_esp_idf.ps1, mindgraph.service.template). Moved library scripts to `scripts/library/` (register_image_folders, rename_library_pages).
- **Admin Scripts Paths**: Updated CHANGELOG v5.23.0 to reflect correct script paths (`scripts/db/`).

### Removed
- **Scripts Root**: Removed scripts from root `scripts/` in favor of organized subdirs (`scripts/db/`, `scripts/setup/`, `scripts/library/`).

## [5.25.0] - 2026-02-25

### Added
- **useDiagramLabels Composable**: New `useDiagramLabels.ts` with `getDiagramTypeDisplayName()` and `getDefaultDiagramName()` for consistent diagram type labels (zh/en) and default names like "新圆圈图" / "New Circle Map" across CanvasTopBar, CanvasPage, WorkshopModal, and diagram templates.

### Changed
- **Diagram Default Names**: Replaced ad-hoc `新${chartType}` logic with `getDefaultDiagramName()` for proper display names (e.g. "新桥形图" instead of raw type). Diagram type now sourced from store when loaded or route query for new diagrams.
- **Bridge Map Label**: Corrected "桥型图" → "桥形图" in CanvasPage, uiConfig templates, and stores.
- **Zoom Controls**: ZoomControls now emits `zoom-in` and `zoom-out` events; CanvasPage handles zoom logic via eventBus. Removed inline zoom math from ZoomControls.
- **DiagramCanvas Fit & Controls**: Removed Vue Flow Controls from DiagramCanvas; zoom/fit moved to ZoomControls overlay. Fit padding top updated to 108px to clear CanvasTopBar (48px) + CanvasToolbar (48px). Canvas area no longer uses pt-16/pt-20; fit excludes toolbar via FIT_PADDING.
- **Context Menu Edit**: InlineEditableText context-menu edit now reuses double-click handler with 50ms defer so menu closes and selection animation shows correctly.

### Removed
- **DiagramCanvas showControls**: Removed Vue Flow Controls component and `show-controls` prop; zoom/fit handled by ZoomControls.

## [5.24.0] - 2026-02-25

### Added
- **Context Menu Copy/Paste**: Implemented copy and paste for diagram nodes. Copy stores selected nodes to clipboard; paste creates duplicates at right-click position. Supports all diagram types.
- **Context Menu Add Node**: Pane right-click "添加节点" now works for circle_map (adds context node), bridge_map (adds analogy pair), and multi_flow_map (add cause/effect). Other types show "coming soon" message.
- **Edit from Context Menu**: Right-click → 编辑 now enters edit mode with text focused and selected. InlineEditableText listens for `node:edit_requested` and triggers startEditing with selection highlight.

### Changed
- **Context Menu Click-Outside**: Fixed menu not closing when clicking elsewhere. Listeners now added/removed via watch on visibility (not just onMount). Uses mousedown capture phase so clicks on Vue Flow canvas close the menu.
- **InlineEditableText Selection**: Added `user-select: text` to override parent nodes' `select-none`, and `::selection` styles for visible text highlight when editing.
- **Diagram Store Clipboard**: Added `copiedNodes`, `copySelectedNodes()`, `pasteNodesAt()`, and `canPaste` computed for clipboard support.

## [5.23.0] - 2026-02-25

### Added
- **Teacher Usage Analytics Dashboard**: Admin-only analytics page for teacher engagement classification. 2-tier classification: unused, continuous, non-continuous (rejection, stopped, intermittent). Includes `TeacherUsagePage.vue` with ECharts visualizations, group stats, configurable thresholds, and recompute support.
- **Teacher Usage Backend**: New `routers/auth/admin/teacher_usage.py` with endpoints: `GET /admin/teacher-usage`, `GET/PUT /admin/teacher-usage/config`, `POST /admin/teacher-usage/recompute`. Reads from pre-computed `user_usage_stats`.
- **Teacher Usage Config Model**: New `TeacherUsageConfig` model for storing classification thresholds (continuous, rejection, stopped, intermittent). Scholars can tweak via UI.
- **Teacher Usage Data Models**: New `UserActivityLog` and `UserUsageStats` models; `services/teacher_usage_stats.py` for computing and upserting stats.
- **Teacher Usage Feature Flag**: `FEATURE_TEACHER_USAGE` in `config/features_config.py` (disabled by default). Frontend feature flags in `useFeatureFlags.ts` and `featureFlags.ts`.
- **Admin Scripts**: `scripts/db/check_admin_status.py` for verifying admin access; `scripts/db/backfill_user_usage_stats.py` for one-time backfill of `user_usage_stats`; `scripts/db/dump_import_postgres.py` for PostgreSQL dump/import.

### Changed
- **App Sidebar & Main Layout**: Added Teacher Usage nav item (admin-only, behind feature flag). Updated `AppSidebar.vue`, `MainLayout.vue`, router.
- **Database Config**: Registered `TeacherUsageConfig` in `config/database.py`.
- **API Config Router**: Updated `routers/api/config.py` for feature flags.
- **Infrastructure**: Updates to lifespan, startup, server launcher, recovery startup, browser, logging config.
- **Schema Migration**: Enhanced `utils/migration/postgresql/schema_migration.py`.
- **TikToken Cache**: Updated `utils/tiktoken_cache.py`.
- **Auth Admin Init**: Registered teacher usage router in `routers/auth/admin/__init__.py`.
- **Env Example**: Added `FEATURE_TEACHER_USAGE` and related env vars.

## [5.22.0] - 2026-02-09

### Changed
- **ESP32 Firmware Architecture**: Major refactoring of ESP32 firmware codebase from monolithic structure to modular component-based architecture using Brookesia framework. Replaced single-file implementations with organized component modules for better maintainability and code organization.
- **ESP32 Build System**: Updated CMakeLists.txt configuration to use standard ESP-IDF project structure with improved component management and build configuration.
- **ESP32 Main Application**: Refactored main.cpp to use Brookesia framework with component-based initialization and improved system architecture.

### Removed
- **ESP32 Legacy Code**: Removed old monolithic firmware implementation files including:
  - Application modules: `dify_app`, `smart_response_app`
  - Manager modules: `asset_manager`, `audio_handler`, `battery_manager`, `button_handler`, `config_manager`, `echo_cancellation`, `font_manager`, `i2c_bus_manager`, `rtc_manager`, `sd_storage`, `ui_manager`, `wallpaper_manager`, `wifi_manager`
  - UI modules: `launcher`, `loading_screen`, `standby_screen`, `ui_icons`
  - Utility modules: `motion_sensor`, `qrcode_generator`, `websocket_client`
- **ESP32 Legacy Configuration**: Removed `.clangd` configuration file and old build configurations.

### Added
- **ESP32 Component Architecture**: New modular component structure with separate components for:
  - Core services: `brookesia_core`, `brookesia_service_manager`, `brookesia_service_audio`, `brookesia_service_wifi`, `brookesia_service_nvs`, `brookesia_service_helper`
  - Agent integrations: `brookesia_agent_coze`, `brookesia_agent_helper`, `brookesia_agent_manager`, `brookesia_agent_openai`, `brookesia_agent_xiaozhi`
  - Application modules: `brookesia_app_ai_profile`, `brookesia_app_calculator`, `brookesia_app_game_2048`, `brookesia_app_pos`, `brookesia_app_settings`, `brookesia_app_squareline_demo`, `brookesia_app_timer`, `brookesia_app_usbd_ncm`
  - Utilities: `brookesia_lib_utils`, `av_processor`
  - Hardware components: `waveshare__esp_lcd_sh8601`
- **ESP32 Gitignore Updates**: Added gitignore entries for ESP32 reference folders (`brookesia-esp/`, `brookesia-waveshare/`).

## [5.21.0] - 2026-02-02

### Added
- **Workshop Collaborative Editing System**: Complete real-time collaborative diagram editing system allowing multiple users to edit diagrams simultaneously. Includes workshop code generation (xxx-xxx format), participant tracking, and real-time synchronization via WebSocket.
- **Workshop Service**: New `services/workshop/workshop_service.py` module for managing workshop sessions with Redis-backed session management, participant tracking with TTL-based expiration, and automatic cleanup of inactive sessions. Supports workshop code generation, session validation, and participant management.
- **Workshop WebSocket Router**: New `routers/api/workshop_ws.py` WebSocket endpoint (`/api/ws/workshop/{code}`) for real-time collaboration with features including:
  - Real-time diagram updates broadcast to all participants
  - User presence tracking and notifications
  - Node-level editing indicators with color-coded visual feedback
  - Granular update support (nodes/connections only) for efficient synchronization
  - Conflict resolution using last-write-wins with timestamps
  - Authentication and session validation via Redis
  - Heartbeat/ping-pong mechanism for connection health monitoring
- **Workshop API Endpoints**: New REST endpoints in `routers/api/diagrams.py`:
  - `POST /api/diagrams/{diagram_id}/workshop/start` - Start a workshop session
  - `POST /api/diagrams/{diagram_id}/workshop/stop` - Stop a workshop session
  - `GET /api/diagrams/{diagram_id}/workshop/status` - Get workshop status
  - `POST /api/workshop/join` - Join a workshop using a code
- **Workshop Frontend Components**: New Vue components and composables:
  - `frontend/src/components/workshop/WorkshopModal.vue` - Modal for managing workshop sessions with QR code generation, code sharing, and participant display
  - `frontend/src/composables/useWorkshop.ts` - Composable for WebSocket connection management, participant tracking, active editor indicators, and automatic reconnection with exponential backoff
- **Workshop Cleanup Service**: New `services/workshop/workshop_cleanup.py` module for background cleanup of expired workshop sessions and inactive participants.
- **Canvas Workshop Integration**: Enhanced `frontend/src/components/canvas/CanvasTopBar.vue` with workshop button, participant bar displaying active collaborators with usernames, and real-time editing indicators showing which users are editing specific nodes.

### Changed
- **Diagram Canvas**: Enhanced `frontend/src/components/diagram/DiagramCanvas.vue` with workshop integration for real-time collaborative updates and node editing notifications.
- **Diagram Store**: Updated `frontend/src/stores/diagram.ts` to support workshop code management and collaborative state synchronization.
- **Event Bus**: Enhanced `frontend/src/composables/useEventBus.ts` with workshop-related events for code changes and participant updates.
- **Diagram Router**: Enhanced `routers/api/diagrams.py` with workshop endpoints and improved rate limiting for workshop operations.

## [5.20.0] - 2026-02-02

### Added
- **Gewe Collection/Favorites Module**: Added collection/favorites management with sync, get content, and delete operations. Includes client mixin (`clients/gewe/collection.py`) and service mixin (`services/gewe/collection.py`) for managing WeChat favorites/collections with pagination support via syncKey.
- **Gewe Tag Management Module**: Added friend tag management system with add, delete, list, and modify friend tags operations. Includes client mixin (`clients/gewe/tag.py`) and service mixin (`services/gewe/tag.py`) for comprehensive tag management including batch operations and friend tag assignment.
- **Gewe Video Channel Module**: Comprehensive video channel (视频号) integration with 30+ operations including follow, comment, browse, publish, like, favorite, search, QR code operations, private messaging, CDN upload, and channel management. Includes client mixin (`clients/gewe/video_channel.py`) and service mixin (`services/gewe/video_channel.py`) for full video channel functionality.
- **Gewe SNS/Moments Service**: Added Moments (朋友圈) service module (`services/gewe/sns.py`) with operations for liking, deleting, sending (text/image/video/link), forwarding, uploading media, and managing privacy settings. Supports visibility controls, tag-based filtering, and contact-based access control.
- **Gewe Response Models**: Added comprehensive Pydantic response models (`models/domain/gewe_responses.py`) for type-safe API responses including login, messages, contacts, groups, webhooks, and all new module responses with proper field aliasing and validation.

### Changed
- **Gewe Client Modules**: Enhanced existing Gewe client modules (`account.py`, `base.py`, `contact.py`, `download.py`, `enterprise.py`, `group.py`, `message.py`, `personal.py`, `sns.py`) with improved error handling, type safety, and code organization.
- **Gewe Service Modules**: Updated Gewe service modules (`base.py`, `contact.py`, `message.py`, `personal.py`, `protocols.py`) with better integration patterns and consistent error handling.
- **Gewe Router**: Enhanced Gewe router (`routers/features/gewe.py`) with improved endpoint organization and response handling.
- **Infrastructure Middleware**: Updated HTTP middleware (`services/infrastructure/http/middleware.py`) with improved request handling and logging.
- **Application Lifecycle**: Enhanced application lifespan (`services/infrastructure/lifecycle/lifespan.py`) and startup (`services/infrastructure/lifecycle/startup.py`) with better initialization and error handling.
- **Logging Configuration**: Improved logging configuration (`services/infrastructure/utils/logging_config.py`) with better log levels and formatting.
- **Database Migration**: Enhanced PostgreSQL schema migration utilities (`utils/migration/postgresql/schema_migration.py`) with improved error handling and validation.
- **TikToken Cache**: Updated tiktoken cache utility (`utils/tiktoken_cache.py`) with improved caching strategies.
- **Frontend Package**: Updated frontend dependencies (`frontend/package.json`) with latest package versions.
- **Ask Once Page**: Enhanced AskOncePage component (`frontend/src/pages/AskOncePage.vue`) with improved UI and functionality.

## [5.19.0] - 2026-02-02

### Added
- **Gewe WeChat Integration**: Complete WeChat integration system with message handling, contact management, and group member tracking. Includes backend services (`services/gewe/`), API client (`clients/gewe/`), database models (`GeweMessage`, `GeweContact`, `GeweGroupMember`), router endpoints (`/api/gewe/webhook`), and admin frontend page (`GewePage.vue`). Supports webhook callbacks for receiving WeChat messages and events.
- **Gewe Configuration**: Added Gewe integration configuration options in `env.example` including `GEWE_TOKEN`, `GEWE_BASE_URL`, and `GEWE_TIMEOUT` settings with documentation for webhook callback URLs.
- **Multi-Flow Map Node Deletion**: Added node deletion functionality for multi-flow maps in Canvas Toolbar, allowing users to delete selected cause/effect nodes.
- **Migration Table Helpers**: New `migration_table_helpers.py` utility module for SQLite migration table operations.

### Changed
- **Bridge Map Agent**: Improved code formatting and PEP8 compliance. Enhanced docstring formatting, fixed line length issues, and improved string formatting using f-strings. Added `**kwargs` parameter for better compatibility with base class.
- **AI Model Selector UI**: Major visual improvements with glassmorphism design, model-specific color themes (Qwen: indigo, DeepSeek: green, Doubao: orange), improved hover effects, and enhanced dark mode support. Removed checkmark icon in favor of color-coded idle states.
- **Canvas Toolbar**: Enhanced with multi-flow map node deletion functionality, allowing users to delete selected cause/effect nodes with proper validation and user feedback.
- **Diagram Components**: Improved FlowNode, TopicNode, LabelNode, and InlineEditableText components with better event handling and user interaction.
- **Multi-Flow Map Store**: Enhanced multi-flow map store with improved node deletion logic and better state management.
- **Bridge Map Store**: Improved bridge map store with better spec loading and error handling.
- **Library Router**: Significant code refactoring and reduction (1254 lines removed) with improved code organization and maintainability.
- **Migration Utilities**: Improved SQLite migration utilities (`migration_backup.py`, `migration_tables.py`, `migration_utils.py`) with better error handling and code organization. Enhanced PostgreSQL data migration utilities.
- **Database Model Registration**: Added Gewe model registration in `config/database.py` for automatic database migration support.
- **Dify API Configuration**: Updated default Dify API URL from custom server (`http://101.42.231.179/v1`) to official API (`https://api.dify.ai/v1`) in `env.example`.
- **SSE Streaming**: Improved Server-Sent Events streaming implementation with better error handling.
- **Admin Page**: Enhanced admin page with Gewe integration access and improved navigation.
- **Router Registration**: Updated router registration to include Gewe feature routes.
- **Clear Library Tables Script**: Improved script with better error handling and user feedback.

### Fixed
- **Code Formatting**: Fixed PEP8 compliance issues throughout codebase, including line length, string formatting, and import organization.
- **Bridge Map Agent**: Fixed variable name inconsistency (`prompt` vs `user_prompt`) in full generation mode.
- **Diagram Canvas**: Improved edge rendering and node interaction handling.
- **Straight Edge Component**: Enhanced edge visualization and interaction.
- **Event Bus**: Improved event handling and type safety.


## [5.18.0] - 2026-01-31

### Added
- **Library Exception Handling**: New `exceptions.py` module with specific exception types (`DocumentNotFoundError`, `PageNotFoundError`, `PageImageNotFoundError`, etc.) for better error handling and clearer error messages.
- **Library Redis Caching**: New `redis_cache.py` module providing Redis-backed caching for library operations (document metadata, danmaku lists) to reduce database load and improve performance in multi-server deployments. Uses cache-aside pattern with configurable TTLs.
- **Endpoint Authentication Audit Scripts**: New `audit_endpoints_auth.py` and `audit_endpoints_simple.py` scripts for auditing API endpoints to identify authentication requirements and potential security issues.
- **Library Page Renaming Script**: New `rename_library_pages.py` script for renaming library page image files to sequential numbering patterns while preserving book names. Includes preview mode (dry-run) support.
- **Library Test Suite**: New `test_library.py` test file for library service testing.
- **Optional Authentication Support**: Added `get_optional_user()` dependency function in library router to allow public access to certain endpoints (document listings, cover images) while maintaining authenticated features.
- **Document Serialization Helper**: Added `serialize_document()` helper function to reduce code duplication across library endpoints.

### Changed
- **Library Router**: Major refactoring with improved error handling using specific exception types, optional authentication support for public endpoints, and better code organization. Added rate limiting support and improved response serialization.
- **Library Service Mixins**: Refactored library service mixins (`library_document_mixin.py`, `library_danmaku_mixin.py`, `library_bookmark_mixin.py`, `library_page_mixin.py`) with improved error handling, Redis caching integration, and better exception handling.
- **Image Viewer Component**: Simplified page navigation logic by removing complex missing page detection and skipping mechanisms. Now relies on standard error handling for missing pages.
- **Library Viewer Page**: Added authentication checks throughout the component. Bookmark operations now require authentication and show login modal for unauthenticated users. Improved error handling for bookmark status checks.
- **Login Modal Component**: Improved UI with better z-index handling (changed from z-[9999] to z-[1000]), removed backdrop blur, and improved close button positioning with better z-index.
- **Diagram Template Input**: Added authentication check to prevent submission when user is not authenticated. Submit button is disabled for unauthenticated users.
- **Mindmate Input Component**: Added authentication check to disable send button when user is not authenticated. Improved disabled state handling with computed property.
- **API Client**: Updated with improved error handling and type definitions for library operations.
- **Server Launcher**: Enhanced server launcher with improved process management and error handling.

### Fixed
- **Library Authentication**: Fixed issue where library features were accessible without authentication. Now properly checks authentication status before allowing bookmark operations and other user-specific features.
- **Login Modal Z-Index**: Fixed z-index conflict by reducing from z-[9999] to z-[1000] and improving close button positioning.
- **Image Viewer Complexity**: Simplified image viewer by removing overly complex page skipping logic that could cause navigation issues. Now uses standard error handling.
- **Error Logging**: Improved error logging throughout library services to use appropriate log levels and provide better context.

## [5.17.0] - 2026-01-30

### Added
- **Image Viewer Component**: New `ImageViewer.vue` component for displaying pre-rendered page images with zoom, navigation, rotation, and pin-based comment overlay support. Supports lazy loading and preloading of adjacent pages.
- **Image Path Resolution Service**: New `image_path_resolver.py` module for resolving page image paths from folder paths and page numbers. Supports multiple naming patterns (page_001.jpg, 001.jpg, page1.jpg, etc.).
- **Library Path Utilities**: New `library_path_utils.py` module for path normalization and cross-platform compatibility utilities.
- **Image Folder Registration Script**: New `register_image_folders.py` script for scanning and registering existing image folders as library documents with preview mode (dry-run) support.
- **Library Table Management Script**: New `clear_library_tables.py` script for clearing library tables in PostgreSQL development environment.
- **PostgreSQL Configuration Modules**: New PostgreSQL management modules (`_postgresql_config.py`, `_postgresql_helpers.py`, `_postgresql_init.py`, `_postgresql_paths.py`) for improved database lifecycle management.
- **Library Bookmark Page**: New `LibraryBookmarkPage.vue` page component for bookmark management.
- **Image-Based Document Support**: Added support for image-based documents in library system with `use_images`, `pages_dir_path`, and `total_pages` fields in `LibraryDocument` model.
- **Page Image API Endpoint**: New `GET /api/library/documents/{id}/pages/{page}` endpoint for serving page images.

### Changed
- **Library Viewer Page**: Updated `LibraryViewerPage.vue` to support both PDF and image viewing modes with automatic mode detection based on document `use_images` flag.
- **Library Service**: Refactored `library_service.py` to support image-based document management, including image folder registration and page counting. Added in-memory page caching with LRU eviction to optimize directory scans and next available page detection.
- **Library Router**: Updated library router endpoints to support image-based documents, including page image serving and document metadata updates. Added `X-Next-Available-Page` header in 404 responses to help frontend automatically skip missing pages.
- **Library Store**: Enhanced `library.ts` store with image-related functionality and improved document management.
- **API Client**: Updated `apiClient.ts` with image URL helpers (`getLibraryDocumentPageImageUrl`) and updated type definitions for image-based documents.
- **Comment Panel**: Updated `CommentPanel.vue` component to work seamlessly with both PDF and image viewers.
- **Danmaku Overlay**: Updated `DanmakuOverlay.vue` component to support image viewer coordinate system.
- **PostgreSQL Manager**: Refactored `_postgresql_manager.py` into modular components for better maintainability and separation of concerns.
- **Application Lifespan**: Updated application lifecycle management to remove PDF auto-import scheduler dependencies.
- **Library Module**: Updated `services/library/__init__.py` to export new image-related services and utilities.
- **Image Viewer Component**: Enhanced `ImageViewer.vue` with automatic page skipping when pages don't exist (404 handling). Automatically detects and navigates to next available page using `X-Next-Available-Page` header from backend.
- **Vite Configuration**: Simplified `vite.config.ts` by removing PDF.js worker and cmaps copying plugins (no longer needed for image-based system).
- **SPA Handler**: Removed PDF.js related static file mounts (`/pdfjs/` and `/cmaps/`) from SPA handler.
- **Exception Handlers**: Improved HTTP exception handling to log expected 404s (missing pages, bookmark checks) at DEBUG level instead of WARNING to reduce log noise.

### Removed
- **PDF Viewer Component**: Removed `PdfViewer.vue` component in favor of image-based viewing system.
- **PDF Import Services**: Removed PDF-related services including `pdf_importer.py`, `pdf_optimizer.py`, `pdf_cover_extractor.py`, and `pdf_utils.py`.
- **PDF Analysis Scripts**: Removed PDF analysis and testing scripts (`analyze_pdf_structure.py`, `analyze_pdf_structure_simple.py`, `compare_pdf_environments.py`, `diagnose_pdf_xref.py`, `fix_pdf_xref_issues.py`, `test_pdf_js_behavior.py`, `test_pdf_optimizer.py`, `test_pdf_text_extraction.py`, `test_range_requests.py`).
- **PDF Import Scripts**: Removed `library_import.py` and `linearize_pdfs.py` scripts.
- **Auto Import Scheduler**: Removed `auto_import_scheduler.py` service for automatic PDF import.
- **Sync Validator**: Removed `sync_validator.py` service for PDF sync validation.
- **WSL Documentation**: Removed `README_WSL.md` documentation file.
- **PDF Toolbar**: Removed `PdfToolbar.vue` component (functionality integrated into viewer components).
- **PDF.js Dependencies**: Removed `pdfjs-dist` npm package and `verify-pdf-worker.js` script from frontend build process.
- **PDF.js Build Plugins**: Removed PDF.js worker and cmaps copying plugins from Vite configuration.

### Fixed
- **Library Comments History**: Fixed and improved `LibraryCommentsHistory.vue` component functionality.
- **Cross-Platform Path Handling**: Improved path normalization for better cross-platform compatibility.
- **Image Viewer Page Navigation**: Fixed issue where image viewer would fail when encountering missing pages. Now automatically skips to next available page using backend-provided `X-Next-Available-Page` header.
- **Library Service Performance**: Optimized page availability checks with in-memory caching (5-minute TTL, LRU eviction) to avoid repeated directory scans when checking for missing pages.
- **Error Logging**: Fixed excessive warning logs for expected 404 errors (missing pages, bookmark checks) by logging them at DEBUG level instead.

## [5.16.0] - 2026-01-30

### Added
- **Library Feature**: Complete library management system with PDF viewer, danmaku (comment overlay), and document management capabilities. Includes full frontend and backend implementation with Vue components, Pinia stores, and FastAPI endpoints.
- **PDF Viewer Component**: Interactive PDF viewer with zoom, navigation, page rendering, and pin/comment overlay support using PDF.js.
- **Danmaku/Comment System**: Real-time comment overlay system for PDF documents with pin-based annotations and comment panels.
- **Library Sync Validation**: Comprehensive sync validation system (`sync_validator.py`) to maintain consistency between PDF files in storage, cover images, and database records. Includes validation functions and sync reporting capabilities.
- **PDF Analysis Scripts**: Added analysis scripts (`analyze_pdf_files.py` and `analyze_pdf_lazy_loading.py`) for analyzing PDF structure and verifying lazy loading feasibility.
- **PDF Utilities Module**: New `pdf_utils.py` module with PDF validation (magic bytes check) and path normalization utilities for cross-platform compatibility.
- **Auto Import Scheduler**: Background automatic PDF import system with startup initialization and periodic background scheduler (`auto_import_scheduler.py`).
- **Library Service**: Complete library service implementation with document management, PDF import, cover extraction, and database operations.
- **Feature Flags System**: Frontend feature flag system for enabling/disabling library features via configuration.
- **API Client Utilities**: Comprehensive API client utilities for frontend-backend communication with error handling and type safety.
- **PDF Cover Extraction**: Automatic cover image extraction from PDF documents with standardized naming (`{document_id}_cover.png`).
- **Diagnostic Endpoints**: Added `/._diagnostic/static-files` endpoint for verifying static file serving configuration.

### Changed
- **PDF Viewer Component**: Significant improvements to PDF viewer component with enhanced functionality (260+ lines added in latest update, 300+ lines in initial implementation).
- **PDF Worker Loading**: Refactored PDF.js worker loading to use `/pdfjs/` directory with StaticFiles mount, consistent with other static file serving patterns.
- **Library Router**: Enhanced library router with comprehensive endpoints for document management, PDF serving, cover images, and library operations.
- **Path Normalization**: Implemented path normalization across all library modules for cross-platform compatibility (WSL/Ubuntu/Windows).
- **Cover Image Handling**: Improved cover image loading with fallback to placeholder icons when images fail to load, removed strict v-if checks.
- **PDF Path Resolution**: Enhanced PDF path resolution with fallback logic (absolute path → storage_dir → CWD) for cross-platform compatibility.
- **Error Handling**: Improved error handling throughout library modules with specific exception types and detailed logging.
- **Duplicate Detection**: Enhanced duplicate detection with normalized path comparison.
- **Auto Import Scheduler**: Updated auto import scheduler with improved error handling and validation logic.
- **Application Lifespan**: Updated application lifecycle management to integrate library auto-import and sync validation features.
- **Static File Serving**: Enhanced static file serving with improved logging and diagnostic capabilities.

### Fixed
- **PDF Viewer Pin Interaction**: Fixed critical issue where PDF library pins were rendered correctly but not clickable or draggable. Root cause was pin elements inheriting `pointer-events: none` from parent layer. Fixed by explicitly setting `pointer-events: auto` inline at multiple lifecycle points.
- **PDF Viewer Worker Loading**: Fixed 404 errors when loading PDF.js worker in production by serving root-level static files from dist/ and adding proper StaticFiles mounts.
- **PDF Viewer Ref Safety**: Added comprehensive null checks for `pinsLayerRef` and `canvasRef` throughout component to prevent errors when refs are not yet available.
- **Library Cover Images**: Fixed issue where cover images didn't show even when files existed by removing strict v-if checks and adding proper error handling.
- **PDF Path Resolution**: Fixed PDF loading issues due to path differences between WSL and Ubuntu environments with improved fallback logic.
- **TypeScript Errors**: Fixed TypeScript errors in PDF viewer components.
- **Linter Errors**: Removed unused `library_auto_import_task` variable from application lifespan module to resolve linter warnings.
- **Danmaku Pin Rendering**: Fixed danmaku pin rendering and click handling in PDF viewer.
- **Library Page Linting**: Fixed linting errors in LibraryPage.vue component.

## [5.15.1] - 2026-01-29

### Fixed
- **PDF Viewer Pin Interaction**: Fixed critical issue where PDF library pins were rendered correctly but not clickable or draggable. The root cause was that pin elements inherited `pointer-events: none` from the parent `.pdf-pins-layer`. Fixed by explicitly setting `pointer-events: auto` inline on pin elements at multiple points in the lifecycle (creation, Vue mounting, DOM appending) and adding `!important` to the CSS rule as a safeguard.
- **PDF Viewer Ref Safety**: Added comprehensive null checks for `pinsLayerRef` and `canvasRef` throughout the component to prevent errors when refs are not yet available, improving stability during component lifecycle transitions.

## [5.15.0] - Previous Release

Initial version tracking.
